<!DOCTYPE html>

<html>
<head>
	<meta charset="utf-8" />

	<title>2048 Game</title>
	
	<link href="https://fonts.googleapis.com/css?family=Roboto:100,400" rel="stylesheet">
	
	<style>* { padding: 0; margin: 0; font-family: 'Roboto', sans-serif; }</style>
	
	<script src="phaser.min.js"></script>

</head>

<body style="background-color:#0A0C0F; text-align:center;">
	
<script>
	
	var config = {
		type: Phaser.AUTO,
		width: 1080,
		height: 1920,
		physics: {
			default: 'arcade',
			arcade: {
				gravity: { y: 0 },
				debug: false
			}
		},
		scale: { mode: Phaser.Scale.FIT },
		scene: {
			preload: preload,
			create: create
		}
	};
	
	function preload() {

		this.load.image('StartScreen_1', 'img/StartScreen_1.png');
		this.load.image('StartScreen_2', 'img/BG 2.png');
		this.load.spritesheet('Logo_Sprite', 'img/Logo_Sprite.png', { frameWidth: 330, frameHeight: 357 });
		this.load.spritesheet('Tile_Sprite', 'img/Tile_Sprite.png', { frameWidth: 180, frameHeight: 180 });
		
		let waiter = "a";
		
		this.load.on('complete', function () {
			waiter = "b";
		});
		
		while (waiter == "a") {
			console.log("waiting...");
		}
		
	}
	
	var game = new Phaser.Game(config);
	var background;
	var background_2;
	var Start_txt;
	var GameOver_txt;
	var GameWin_txt;
	var matrix = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
	var numberOfExistingTiles;
	var tileArray = [];
	var tileSprite0,tileSprite1,tileSprite2,tileSprite3;
	var tileSprite4,tileSprite5,tileSprite6,tileSprite7;
	var tileSprite8,tileSprite9,tileSprite10,tileSprite11;
	var tileSprite12,tileSprite13,tileSprite14,tileSprite15;
	var mode;
	var startPosX;
	var startPosY;
	var stopPosX;
	var stopPosY;
	var pointerMode;
	var matrixSave = [];
	
	function create() {
		
		background = this.add.image(540, 960, 'StartScreen_1');
		background_2 = this.add.image(540, 960, 'StartScreen_2').setAlpha(0);
		anim = this.anims.create({
			key: 'buildup',
   			frames: this.anims.generateFrameNumbers('Logo_Sprite'),
        	frameRate: 28,
        	yoyo: false
        });
		sprite = this.add.sprite(540, 800, 'Logo_Sprite').setAlpha(0);
		sprite.anims.load('buildup');
		
		tileArray.push((tileSprite0 = this.add.sprite(267, 517, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite1 = this.add.sprite(449, 517, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite2 = this.add.sprite(631, 517, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite3 = this.add.sprite(813, 517, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite4 = this.add.sprite(267, 699, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite5 = this.add.sprite(449, 699, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite6 = this.add.sprite(631, 699, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite7 = this.add.sprite(813, 699, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite8 = this.add.sprite(267, 881, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite9 = this.add.sprite(449, 881, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite10 = this.add.sprite(631, 881, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite11 = this.add.sprite(813, 881, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite12 = this.add.sprite(267, 1063, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite13 = this.add.sprite(449, 1063, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite14 = this.add.sprite(631, 1063, 'Tile_Sprite').setAlpha(0)));
		tileArray.push((tileSprite15 = this.add.sprite(813, 1063, 'Tile_Sprite').setAlpha(0)));
		
		
		Start_txt = this.add.text(483, 960, 'Start', { fontFamily: 'Roboto', fontStyle: 100, fontSize: 60, color: '#dddddd'}).setAlpha(0);
		GameOver_txt = this.add.text(400, 320, 'Game Over', { fontFamily: 'Roboto', fontStyle: 100, fontSize: 60, color: '#dddddd'}).setAlpha(0);
		GameWin_txt = this.add.text(423, 320, 'You Won!', { fontFamily: 'Roboto', fontStyle: 100, fontSize: 60, color: '#dddddd'}).setAlpha(0);
		
        this.input.on('pointerdown', function swipeStart(pointer) {
			if (mode == "play") {
                startPosX = pointer.x;
                startPosY = pointer.y;
			};
        });
		
        this.input.on('pointerup', function swipeStop(pointer) {
			if (mode == "play") {
                stopPosX = pointer.x;
                stopPosY = pointer.y;
                var directionX = stopPosX - startPosX;
                var directionY = stopPosY - startPosY;
				
				matrixSaver();

                if (Math.abs(directionX) > Math.abs(directionY) && directionX > 0) {
					moveTiles("rechts");
					checkInvalidMove();
                } else if (Math.abs(directionX) > Math.abs(directionY) && directionX < 0) {
                    moveTiles("links");
					checkInvalidMove();
                } else if (Math.abs(directionX) < Math.abs(directionY) && directionY > 0) {
					moveTiles("runter");
					checkInvalidMove();
                } else if (Math.abs(directionX) < Math.abs(directionY) && directionY < 0) {
					moveTiles("hoch");
					checkInvalidMove();
                } else {
                    console.log ("funny");
                };

                startPosX = 0;
                startPosY = 0;
                stopPosX = 0;
                stopPosY = 0;
			};
        });
		
		var anim1 = this.tweens.add({
			targets: sprite,
			props: { alpha: { value: '1', duration: 250, ease: 'Power1' } },
			delay: 100,
			onStart: function () { sprite.anims.play('buildup'); },
			onStartParams: [ sprite ],
			completeDelay: 250,
			onComplete: function () {
				Start_txt.setAlpha(1);
				background.setInteractive();
				background.on('pointerup', function () { anim2.resume(); } );
			}
    	});
		
		var anim2 = this.tweens.add({
			targets: sprite,
			props: { scaleX: { value: '18', duration: 200, ease: 'Power1' },
				   	scaleY: { value: '18', duration: 200, ease: 'Power1' },
					x: { value: '480', duration: 200, ease: 'Power1' },
					y: { value: '1150', duration: 200, ease: 'Power1' },
					alpha: { value: '0', duration: 200, ease: 'Power1' }
				   },
			paused: true,
			onStart: function () { Start_txt.setAlpha(0); background_2.setAlpha(1); },
			onComplete: function () { start2048(); }
    	});

	}
	
	function checkInvalidMove() {
		
		var step1 = matrixSave.join();
		var step2 = [];
		
		matrix.forEach(function(element) {
			if (element == 0) {
				step2.push("A");
			} else {
				step2.push(element.number);
			}
		});
		step2 = step2.join();
		if (step1 != step2) {
        	updateTiles();
			placeTile();
        }
		matrixSave = [];
	}
	
	function matrixSaver () {
		matrix.forEach(function(element) {
			if (element == 0) {
				matrixSave.push("A");
			} else {
				matrixSave.push(element.number);
			}
		});
	}
	
	function moveTiles(steering) {
		if (steering == "rechts") {
		for (var k = 0; k <= 12; k = k+4) { // geht FliesenreiheN durch
            for (var j = 3; j > 0; j--) { // geht Fliesenreihe durch
                for (var i = j; i > 0; i--) { // geht Fliesenposition durch
                    if (matrix[j+k] == 0) {
                        matrix.splice(j+k, 1);
                        matrix.splice(k, 0, 0);
                    } else if (matrix[j+k].number == matrix[j+k-1].number && matrix[j+k].combined == false && matrix[j+k-1].combined == false) {
                        matrix[j+k].combined = true;
                        matrix.splice(j+k-1, 1);
						matrix.splice(k, 0, 0);
						numberOfExistingTiles--;
                    } else if (matrix[j+k] != 0 && matrix[j+k-1] == 0) {
                        matrix.splice(j+k-1, 1);
						matrix.splice(k, 0, 0);
                    } else {
                        break;
                    }
                }
            }
		}
		} else if (steering == "runter") {
		for (var k = 0; k <= 3; k++) { // geht FliesenreiheN durch
            for (var j = 12; j > 0; j = j-4) { // geht Fliesenreihe durch
                for (var i = (j/4); i > 0; i--) { // geht Fliesenposition durch
                    if (matrix[j+k] == 0) {
						for (var h = 0; h < (j/4); h++) {
                        	matrix.splice(j-(h*4)+k, 1, (matrix[j-(h*4)+k-4]));
						}
						matrix.splice(k, 1, 0);
                    } else if (matrix[j+k].number == matrix[j+k-4].number && matrix[j+k].combined == false && matrix[j+k-4].combined == false) {
						matrix[j+k].combined = true;
                        for (var h = 1; h < (j/4); h++) {
							matrix.splice(j-(h*4)+k, 1, (matrix[j-(h*4)+k-4]));
						}
						matrix.splice(k, 1, 0);
						numberOfExistingTiles--;
                    } else if (matrix[j+k] != 0 && matrix[j+k-4] == 0) {
						for (var h = 1; h < (j/4); h++){
							matrix.splice(j-(h*4)+k, 1, (matrix[j-(h*4)+k-4]));
						}
						matrix.splice(k, 1, 0);
                    } else {
                        break;
                    }
                }
            }
		}
		} else if (steering == "links") {
		for (var k = 0; k <= 12; k = k+4) { // geht FliesenreiheN durch
            for (var j = 0; j < 3; j++) { // geht Fliesenreihe durch
                for (var i = 3; i > j; i--) { // geht Fliesenposition durch
                    if (matrix[j+k] == 0) {
                        matrix.splice(j+k, 1);
                        matrix.splice(k+3, 0, 0);
                    } else if (matrix[j+k].number == matrix[j+k+1].number && matrix[j+k].combined == false && matrix[j+k+1].combined == false) {
                        matrix[j+k].combined = true;
                        matrix.splice(j+k+1, 1);
						matrix.splice(k+3, 0, 0);
						numberOfExistingTiles--;
                    } else if (matrix[j+k] != 0 && matrix[j+k+1] == 0) {
                        matrix.splice(j+k+1, 1);
						matrix.splice(k+3, 0, 0);
                    } else {
                        break;
                    }
                }
            }
		}
		} else if (steering == "hoch") {
		for (var k = 0; k <= 3; k++) { // geht FliesenreiheN durch
            for (var j = 0; j < 12; j = j+4) { // geht Fliesenreihe durch
                for (var i = 0; i < 3-(j/4); i++) { // geht Fliesenposition durch
                    if (matrix[j+k] == 0) {
						for (var h = 0; h < 3-(j/4); h++) {
                        	matrix.splice((j+(h*4)+k), 1, (matrix[j+(h*4)+k+4]));
						}
						matrix.splice(12+k, 1, 0);
                    } else if (matrix[j+k].number == matrix[j+k+4].number && matrix[j+k].combined == false && matrix[j+k+4].combined == false) {
						matrix[j+k].combined = true;
                        for (var h = 1; h < 3-(j/4); h++){
							matrix.splice(j+(h*4)+k, 1, (matrix[j+(h*4)+k+4]));
						}
						matrix.splice(12+k, 1, 0);
						numberOfExistingTiles--;
                    } else if (matrix[j+k] != 0 && matrix[j+k+4] == 0) {
						for (var h = 1; h < 3-(j/4); h++){
							matrix.splice(j+(h*4)+k, 1, (matrix[j+(h*4)+k+4]));
						}
						matrix.splice(12+k, 1, 0);
                    } else {
                        break;
                    }
                }
            }
		}
		}
	}
	
	function start2048() {
		numberOfExistingTiles = 0;
		placeTile();
		placeTile();
		mode = "play";
	}
	
	function placeTile() {
		if (numberOfExistingTiles < 16) {
			var tile = new Tile();
			matrix.splice(tile.place, 1, tile)
			numberOfExistingTiles++;
			updateView();
		} else {
			gameOver();
		}
	}
	
	function gameOver() {
		GameOver_txt.setAlpha(1);
		mode = "";
	}
	
	function gameWin() {
		GameWin_txt.setAlpha(1);
		mode = "";
	}
	
	function updateTiles() {
		matrix.forEach(function(element) {
			if (element.combined == true) {
				element.number = element.number + 1;
				if (element.number >= 10){
					gameWin();
				}
				element.combined = false;
			}
		});
	}
	
	function Tile(place, number) {
		this.place = getRandomInt(16, "place");
		this.number = getRandomInt(2, "number");
		this.combined = false;
	}
	
	function getRandomInt(max, place) {
  		if (place == "number") {
			return Math.floor(Math.random() * Math.floor(max));
		}else if (place == "place") {
			var generatedNumber = Math.floor(Math.random() * Math.floor(max));
			while (matrix[generatedNumber] != 0) {
				generatedNumber = Math.floor(Math.random() * Math.floor(max));
			}
			return generatedNumber;
		}
	}
	
	function updateView() {
		for (var i = 0; i < 16; i++) {
			if (matrix[i] != 0) {
				tileArray[i].setAlpha(1);
				tileArray[i].setFrame(matrix[i].number);
			} else {
				tileArray[i].setAlpha(0);
			}
		}
	}
	
</script>
</body>

</html>